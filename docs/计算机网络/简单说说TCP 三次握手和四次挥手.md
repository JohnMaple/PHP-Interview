## TCP 三次握手和四次挥手
TCP 三次握手和四次挥手也是面试题的热门考点，它们分别对应 TCP 的连接和释放过程。下面就来简单认识一下这两个过程
### TCP 三次握手
在了解具体的流程之前，我们先认识一下几个概念

![](https://gitee.com/yefangyong/blog-image/raw/master/png/20201029143610.png)

- `SYN`：它的全称是 `Synchronize Sequence Numbers`，同步序列编号。是 `TCP/IP` 建立连接时使用的握手信号。在客户机和服务器之间建立 `TCP` 连接时，首先会发送的一个信号。客户端在接受到 SYN 消息时，就会在自己的段内生成一个随机值 X。

- `SYN-ACK`：服务器收到 SYN 后，打开客户端连接，发送一个 `SYN-ACK` 作为答复。确认号设置为比接收到的序列号多一个，即 X + 1，服务器为数据包选择的序列号是另一个随机数 Y。

- `ACK`：`Acknowledge character`, 确认字符，表示发来的数据已确认接收无误。最后，客户端将 `ACK` 发送给服务器。序列号被设置为所接收的确认值即 Y + 1。

![](https://gitee.com/yefangyong/blog-image/raw/master/png/20201029143759.png)

通俗举例：小红：客户端  小明：服务端

- 小红给小明打电话，接通了之后，小红说，喂，你听到吗？这就相当于请求建立链接
- 小明给小红回应，说我听到，你听到吗？这就相当于请求响应
- 小红听到小明的回应之后，说我听到，到此连接建立，两个人开始bb（交换信息）

### TCP 四次挥手
在连接终止阶段使用四次挥手，连接的每一端都会独立的终止。下面我们来描述一下这个过程。
![](https://gitee.com/yefangyong/blog-image/raw/master/png/20201029145714.png)

-  首先，客户端应用程序决定要终止连接(这里服务端也可以选择断开连接)。这会使客户端将 `FIN` 发送到服务器，并进入 `FIN_WAIT_1` 状态。当客户端处于 `FIN_WAIT_1` 状态时，它会等待来自服务器的 `ACK` 响应。
- 然后第二步，当服务器收到 `FIN` 消息时，服务器会立刻向客户端发送 `ACK` 确认消息。
- 当客户端收到服务器发送的 `ACK` 响应后，客户端就进入 `FIN_WAIT_2` 状态，然后等待来自服务器的 `FIN` 消息
- 服务器发送 `ACK` 确认消息后，一段时间（可以进行关闭后）会发送 `FIN` 消息给客户端，告知客户端可以进行关闭。
- 当客户端收到从服务端发送的 `FIN` 消息时，客户端就会由 `FIN_WAIT_2` 状态变为 `TIME_WAIT` 状态。处于 `TIME_WAIT` 状态的客户端允许重新发送 `ACK` 到服务器为了防止信息丢失。客户端在 `TIME_WAIT` 状态下花费的时间取决于它的实现，在等待一段时间后，连接关闭，客户端上所有的资源（包括端口号和缓冲区数据）都被释放。

还是继续用上面通话的例子进行举例：

- 小红对小明说，我话讲完了，我要挂断电话了。
- 小明说，收到，我这边还有一些东西没有说。
- 经过若干时间后，小明说，我说完了，可以挂断电话了
- 小红收到消息后，又等了若干时间挂断了电话
